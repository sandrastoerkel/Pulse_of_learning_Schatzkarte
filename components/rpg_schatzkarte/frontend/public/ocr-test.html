<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>OCR Test - Tesseract.js</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      padding: 20px;
      color: #fff;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      color: #FFD700;
      margin-bottom: 10px;
      font-size: 24px;
    }

    .subtitle {
      text-align: center;
      color: #888;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .camera-section {
      background: rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .camera-preview {
      width: 100%;
      aspect-ratio: 4/3;
      background: #000;
      border-radius: 12px;
      margin-bottom: 15px;
      overflow: hidden;
      position: relative;
    }

    .camera-preview video,
    .camera-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .camera-preview img {
      display: none;
    }

    .buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      flex: 1;
      min-width: 120px;
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #1a1a2e;
    }

    .btn-secondary {
      background: rgba(255,255,255,0.15);
      color: #fff;
    }

    .btn-danger {
      background: rgba(255,82,82,0.3);
      color: #FF5252;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button:active:not(:disabled) {
      transform: scale(0.98);
    }

    .status {
      background: rgba(255,215,0,0.1);
      border: 1px solid rgba(255,215,0,0.3);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
    }

    .status.error {
      background: rgba(255,82,82,0.1);
      border-color: rgba(255,82,82,0.3);
      color: #FF5252;
    }

    .status.success {
      background: rgba(74,222,128,0.1);
      border-color: rgba(74,222,128,0.3);
      color: #4ADE80;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      margin-top: 10px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #FFD700, #FFA500);
      border-radius: 4px;
      transition: width 0.3s;
      width: 0%;
    }

    .result-section {
      background: rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .result-section h2 {
      color: #FFD700;
      font-size: 18px;
      margin-bottom: 15px;
    }

    .result-text {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 15px;
      min-height: 150px;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.6;
      color: #E8DCC8;
    }

    .cards-section {
      background: rgba(74,222,128,0.1);
      border: 1px solid rgba(74,222,128,0.3);
      border-radius: 16px;
      padding: 20px;
    }

    .cards-section h2 {
      color: #4ADE80;
      font-size: 18px;
      margin-bottom: 15px;
    }

    .card-item {
      display: flex;
      gap: 10px;
      padding: 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      margin-bottom: 8px;
      align-items: center;
    }

    .card-front {
      flex: 1;
      color: #fff;
      font-weight: 500;
    }

    .card-arrow {
      color: #4ADE80;
    }

    .card-back {
      flex: 1;
      color: #FFD700;
      text-align: right;
    }

    .tips {
      background: rgba(79,195,247,0.1);
      border: 1px solid rgba(79,195,247,0.3);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #4FC3F7;
    }

    .tips h3 {
      margin-bottom: 8px;
    }

    .tips ul {
      margin-left: 20px;
    }

    .tips li {
      margin-bottom: 4px;
    }

    .language-select {
      margin-bottom: 15px;
    }

    .language-select label {
      display: block;
      margin-bottom: 8px;
      color: #888;
      font-size: 14px;
    }

    .language-select select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.3);
      color: #fff;
      font-size: 16px;
    }

    .hidden {
      display: none !important;
    }

    .time-info {
      text-align: center;
      color: #888;
      font-size: 13px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üì∑ OCR Test</h1>
    <p class="subtitle">Tesseract.js Texterkennung</p>

    <div class="tips">
      <h3>üí° Tipps f√ºr beste Ergebnisse:</h3>
      <ul>
        <li>Gute Beleuchtung, kein Schatten</li>
        <li>Text gerade ausrichten</li>
        <li>Klare, gedruckte Schrift funktioniert am besten</li>
        <li>Format: "Wort - √úbersetzung" pro Zeile</li>
      </ul>
    </div>

    <div class="camera-section">
      <div class="language-select">
        <label>Sprache der Texterkennung:</label>
        <select id="langSelect">
          <option value="deu">Deutsch</option>
          <option value="eng">Englisch</option>
          <option value="deu+eng" selected>Deutsch + Englisch</option>
          <option value="fra">Franz√∂sisch</option>
          <option value="lat">Latein</option>
          <option value="spa">Spanisch</option>
        </select>
      </div>

      <div class="camera-preview">
        <video id="video" autoplay playsinline></video>
        <img id="photo" alt="Aufgenommenes Foto">
      </div>

      <div class="buttons">
        <button id="startBtn" class="btn-primary">üì∑ Kamera starten</button>
        <button id="captureBtn" class="btn-primary hidden">üì∏ Foto aufnehmen</button>
        <button id="retakeBtn" class="btn-secondary hidden">üîÑ Neu aufnehmen</button>
        <button id="scanBtn" class="btn-primary hidden">üîç Text erkennen</button>
      </div>

      <div style="text-align: center; margin-top: 15px; color: #888;">‚Äî oder ‚Äî</div>

      <div class="buttons" style="margin-top: 15px;">
        <label class="btn-secondary" style="text-align: center; cursor: pointer;">
          üìÅ Bild hochladen
          <input type="file" id="fileInput" accept="image/*" style="display: none;">
        </label>
      </div>
    </div>

    <div id="statusSection" class="status hidden">
      <div id="statusText">Bereit...</div>
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill"></div>
      </div>
    </div>

    <div id="resultSection" class="result-section hidden">
      <h2>üìù Erkannter Text:</h2>
      <div id="resultText" class="result-text"></div>
      <div id="timeInfo" class="time-info"></div>
    </div>

    <div id="cardsSection" class="cards-section hidden">
      <h2>üÉè Erkannte Karteikarten:</h2>
      <div id="cardsList"></div>
    </div>
  </div>

  <canvas id="canvas" style="display: none;"></canvas>

  <script>
    const video = document.getElementById('video');
    const photo = document.getElementById('photo');
    const canvas = document.getElementById('canvas');
    const startBtn = document.getElementById('startBtn');
    const captureBtn = document.getElementById('captureBtn');
    const retakeBtn = document.getElementById('retakeBtn');
    const scanBtn = document.getElementById('scanBtn');
    const statusSection = document.getElementById('statusSection');
    const statusText = document.getElementById('statusText');
    const progressFill = document.getElementById('progressFill');
    const resultSection = document.getElementById('resultSection');
    const resultText = document.getElementById('resultText');
    const timeInfo = document.getElementById('timeInfo');
    const cardsSection = document.getElementById('cardsSection');
    const cardsList = document.getElementById('cardsList');
    const langSelect = document.getElementById('langSelect');
    const fileInput = document.getElementById('fileInput');

    let stream = null;
    let worker = null;

    // Bild hochladen
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        // Kamera stoppen falls aktiv
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }

        photo.src = event.target.result;
        video.classList.add('hidden');
        photo.classList.remove('hidden');
        startBtn.classList.add('hidden');
        captureBtn.classList.add('hidden');
        retakeBtn.classList.remove('hidden');
        scanBtn.classList.remove('hidden');

        resultSection.classList.add('hidden');
        cardsSection.classList.add('hidden');
        statusSection.classList.add('hidden');
      };
      reader.readAsDataURL(file);
    });

    // Kamera starten
    startBtn.addEventListener('click', async () => {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment', // R√ºckkamera
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        });
        video.srcObject = stream;
        video.classList.remove('hidden');
        photo.classList.add('hidden');
        startBtn.classList.add('hidden');
        captureBtn.classList.remove('hidden');
      } catch (err) {
        alert('Kamera-Zugriff nicht m√∂glich: ' + err.message);
      }
    });

    // Foto aufnehmen
    captureBtn.addEventListener('click', () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      photo.src = canvas.toDataURL('image/jpeg', 0.9);

      // Kamera stoppen
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }

      video.classList.add('hidden');
      photo.classList.remove('hidden');
      captureBtn.classList.add('hidden');
      retakeBtn.classList.remove('hidden');
      scanBtn.classList.remove('hidden');
    });

    // Neu aufnehmen
    retakeBtn.addEventListener('click', async () => {
      resultSection.classList.add('hidden');
      cardsSection.classList.add('hidden');
      statusSection.classList.add('hidden');

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        });
        video.srcObject = stream;
        video.classList.remove('hidden');
        photo.classList.add('hidden');
        retakeBtn.classList.add('hidden');
        scanBtn.classList.add('hidden');
        captureBtn.classList.remove('hidden');
      } catch (err) {
        alert('Kamera-Zugriff nicht m√∂glich: ' + err.message);
      }
    });

    // Text erkennen
    scanBtn.addEventListener('click', async () => {
      const startTime = Date.now();
      const lang = langSelect.value;

      statusSection.classList.remove('hidden');
      statusSection.className = 'status';
      statusText.textContent = 'Lade Tesseract...';
      progressFill.style.width = '10%';

      scanBtn.disabled = true;
      retakeBtn.disabled = true;

      try {
        statusText.textContent = 'Erkenne Text... (kann 5-15 Sekunden dauern)';
        progressFill.style.width = '30%';

        const result = await Tesseract.recognize(
          photo.src,
          lang,
          {
            logger: m => {
              if (m.status === 'recognizing text') {
                const progress = Math.round(30 + m.progress * 60);
                progressFill.style.width = progress + '%';
                statusText.textContent = `Erkenne Text... ${Math.round(m.progress * 100)}%`;
              }
            }
          }
        );

        progressFill.style.width = '100%';
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

        statusSection.className = 'status success';
        statusText.textContent = '‚úì Erkennung abgeschlossen!';

        // Ergebnis anzeigen
        resultSection.classList.remove('hidden');
        resultText.textContent = result.data.text || '(Kein Text erkannt)';
        timeInfo.textContent = `Erkennungszeit: ${elapsed} Sekunden`;

        // Karteikarten parsen
        const cards = parseCards(result.data.text);
        if (cards.length > 0) {
          cardsSection.classList.remove('hidden');
          cardsList.innerHTML = cards.map(c => `
            <div class="card-item">
              <span class="card-front">${c.front}</span>
              <span class="card-arrow">‚Üí</span>
              <span class="card-back">${c.back}</span>
            </div>
          `).join('');
        }

      } catch (err) {
        statusSection.className = 'status error';
        statusText.textContent = 'Fehler: ' + err.message;
      } finally {
        scanBtn.disabled = false;
        retakeBtn.disabled = false;
      }
    });

    // Karteikarten aus Text parsen
    function parseCards(text) {
      const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 2);
      const separators = ['\t', ' - ', ' ‚Äì ', ' = ', ' : ', '; ', ' / '];

      // Besten Separator finden
      let bestSep = ' - ';
      let bestCount = 0;
      for (const sep of separators) {
        const count = lines.filter(l => l.includes(sep)).length;
        if (count > bestCount) {
          bestCount = count;
          bestSep = sep;
        }
      }

      const cards = [];
      for (const line of lines) {
        const idx = line.indexOf(bestSep);
        if (idx > 0) {
          const front = line.slice(0, idx).trim();
          const back = line.slice(idx + bestSep.length).trim();
          if (front && back) {
            cards.push({ front, back });
          }
        }
      }

      return cards;
    }
  </script>
</body>
</html>
